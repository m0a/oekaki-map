# Oekaki Map

åœ°å›³ä¸Šã«è‡ªç”±ã«ãŠçµµã‹ãã—ã¦å…±æœ‰ã§ãã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚

**æœ¬ç•ªURL**: https://oekaki-map.abe00makoto.workers.dev

## ç‰¹å¾´

- **åœ°å›³ãŠçµµã‹ã**: OpenStreetMapä¸Šã«è‡ªç”±ã«æç”»
- **URLå…±æœ‰**: æã„ãŸçµµã‚’URLã§ç°¡å˜ã«å…±æœ‰
- **ãƒ¬ã‚¤ãƒ¤ãƒ¼æ©Ÿèƒ½**: è¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§çµµã‚’ç®¡ç†
- **Undo/Redo**: æç”»å±¥æ­´ã®å–ã‚Šæ¶ˆã—ãƒ»ã‚„ã‚Šç›´ã—
- **OGPå¯¾å¿œ**: SNSã§ã‚·ã‚§ã‚¢æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’è¡¨ç¤º
- **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ**: ã‚¿ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§é«˜é€Ÿè¡¨ç¤º

## ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [åœ°å›³]                              â”‚
â”‚                                     â”‚
â”‚    ğŸ—ºï¸ + âœï¸ = ğŸ¨                     â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ¨ â—¯ â†©ï¸ â†ªï¸ âœï¸ ğŸ§¹ âœ‹ ğŸ“‘ ğŸ“ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- **React 18** - UIãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **TypeScript** - å‹å®‰å…¨ãªé–‹ç™º
- **Vite** - é«˜é€Ÿãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«
- **Leaflet** - åœ°å›³ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- **Hono** - è»½é‡Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- **Cloudflare Workers** - ã‚¨ãƒƒã‚¸ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¤ãƒ³ãƒ•ãƒ©
- **Cloudflare D1** - SQLiteãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- **Cloudflare R2** - ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆã‚¿ã‚¤ãƒ«ç”»åƒï¼‰
- **GitHub Actions** - CI/CD

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚â”€â”€â”€â”€â–¶â”‚ Cloudflare Workersâ”‚â”€â”€â”€â”€â–¶â”‚   D1    â”‚
â”‚  (React)    â”‚â—€â”€â”€â”€â”€â”‚     (Hono)       â”‚â—€â”€â”€â”€â”€â”‚ (SQLite)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      R2      â”‚
                    â”‚ (Tile Images)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

1. **æç”»**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåœ°å›³ä¸Šã«æç”»
2. **ã‚¿ã‚¤ãƒ«åˆ†å‰²**: æç”»å†…å®¹ã‚’256x256pxã®ã‚¿ã‚¤ãƒ«ã«åˆ†å‰²
3. **ä¿å­˜**: ã‚¿ã‚¤ãƒ«ç”»åƒã‚’R2ã«ä¿å­˜ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’D1ã«ä¿å­˜
4. **å…±æœ‰**: URLã‚’å…±æœ‰ã™ã‚‹ã¨åŒã˜çµµãŒè¡¨ç¤ºã•ã‚Œã‚‹
5. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: HTTPã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ1å¹´ï¼‰ã§R2ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šæ¸›

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```
oekaki-map/
â”œâ”€â”€ frontend/                 # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (React)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/      # UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ MapWithDrawing/  # åœ°å›³+æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹
â”‚   â”‚   â”‚   â”œâ”€â”€ Toolbar/         # ãƒ„ãƒ¼ãƒ«ãƒãƒ¼
â”‚   â”‚   â”‚   â””â”€â”€ LayerPanel/      # ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«
â”‚   â”‚   â”œâ”€â”€ hooks/           # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
â”‚   â”‚   â”‚   â”œâ”€â”€ useCanvas.ts     # ã‚­ãƒ£ãƒ³ãƒã‚¹çŠ¶æ…‹ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ useUndoRedo.ts   # Undo/Redoæ©Ÿèƒ½
â”‚   â”‚   â”‚   â”œâ”€â”€ useLayers.ts     # ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ useTileCache.ts  # ã‚¿ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
â”‚   â”‚   â”œâ”€â”€ services/        # APIé€šä¿¡
â”‚   â”‚   â”œâ”€â”€ utils/           # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚   â””â”€â”€ types/           # å‹å®šç¾©
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ backend/                  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Hono)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ routes/          # APIãƒ«ãƒ¼ãƒˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ canvas.ts        # ã‚­ãƒ£ãƒ³ãƒã‚¹CRUD
â”‚   â”‚   â”‚   â”œâ”€â”€ tiles.ts         # ã‚¿ã‚¤ãƒ«å–å¾—ãƒ»ä¿å­˜
â”‚   â”‚   â”‚   â””â”€â”€ layers.ts        # ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ services/        # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â””â”€â”€ types/           # å‹å®šç¾©
â”‚   â”œâ”€â”€ migrations/          # D1ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â””â”€â”€ wrangler.toml        # Cloudflareè¨­å®š
â”œâ”€â”€ specs/                    # è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â””â”€â”€ README.md
```

## é–‹ç™ºç’°å¢ƒ

### å‰ææ¡ä»¶

- Node.js 20+
- pnpm
- Cloudflare ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ï¼‰

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/m0a/oekaki-map.git
cd oekaki-map

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm install
cd frontend && pnpm install
cd ../backend && pnpm install

# ãƒ­ãƒ¼ã‚«ãƒ«DBã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
cd backend
pnpm exec wrangler d1 migrations apply DB --local

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰
pnpm dev
```

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰:
```bash
cd frontend
pnpm dev
```

### ãƒ†ã‚¹ãƒˆ

```bash
# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
cd frontend && pnpm test

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
cd backend && pnpm test

# å‹ãƒã‚§ãƒƒã‚¯
pnpm run type-check
```

### Lint

```bash
pnpm lint
```

## API

### Canvas API

| Method | Endpoint | èª¬æ˜ |
|--------|----------|------|
| POST | `/api/canvas` | æ–°è¦ã‚­ãƒ£ãƒ³ãƒã‚¹ä½œæˆ |
| GET | `/api/canvas/:id` | ã‚­ãƒ£ãƒ³ãƒã‚¹å–å¾— |
| PUT | `/api/canvas/:id` | ã‚­ãƒ£ãƒ³ãƒã‚¹æ›´æ–° |

### Tiles API

| Method | Endpoint | èª¬æ˜ |
|--------|----------|------|
| GET | `/api/canvas/:id/tiles/:z/:x/:y` | ã‚¿ã‚¤ãƒ«ç”»åƒå–å¾— |
| POST | `/api/canvas/:id/tiles` | ã‚¿ã‚¤ãƒ«ä¿å­˜ |

### Layers API

| Method | Endpoint | èª¬æ˜ |
|--------|----------|------|
| GET | `/api/canvas/:id/layers` | ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§å–å¾— |
| POST | `/api/canvas/:id/layers` | ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ |
| PUT | `/api/canvas/:id/layers/:layerId` | ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–° |
| DELETE | `/api/canvas/:id/layers/:layerId` | ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤ |

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

Wrangler D1ã®å…¬å¼ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’ä½¿ç”¨ã€‚

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«

```
backend/migrations/
â”œâ”€â”€ 0001_initial_schema.sql
â”œâ”€â”€ 0002_add_layers.sql
â”œâ”€â”€ 0003_add_share_state.sql
â””â”€â”€ 0004_add_ogp_fields.sql
```

### æ–°è¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®è¿½åŠ 

```bash
# 1. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
touch backend/migrations/0005_add_new_table.sql

# 2. SQLã‚’è¨˜è¿°
# 3. ãƒ­ãƒ¼ã‚«ãƒ«ã§é©ç”¨
cd backend
pnpm exec wrangler d1 migrations apply DB --local

# 4. ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ç¢ºèª

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«
pnpm exec wrangler d1 migrations list DB --local

# ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ
pnpm exec wrangler d1 migrations list DB --remote --env preview

# æœ¬ç•ªç’°å¢ƒ
pnpm exec wrangler d1 migrations list DB --remote
```

## ãƒ‡ãƒ—ãƒ­ã‚¤

### CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

| ã‚¤ãƒ™ãƒ³ãƒˆ | å¯¾è±¡ç’°å¢ƒ | URL |
|---------|---------|-----|
| PRä½œæˆ/æ›´æ–° | PR Preview | `https://oekaki-map-pr-{N}.abe00makoto.workers.dev` |
| mainãƒãƒ¼ã‚¸ | Main Preview | `https://oekaki-map-main-preview.abe00makoto.workers.dev` |
| ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥ (v*) | Production | `https://oekaki-map.abe00makoto.workers.dev` |

### æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹æ‰‹é †

Claude Codeã® `/release` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰:

```bash
# Claude Codeã§å®Ÿè¡Œ
/release
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯è‡ªå‹•çš„ã«:
1. æœ€æ–°ã‚¿ã‚°ã‚’å–å¾—
2. æ¬¡ã®ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨ˆç®—ï¼ˆä¾‹: v0.0.11 â†’ v0.0.12ï¼‰
3. å¤‰æ›´å†…å®¹ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
4. ã‚¿ã‚°ä½œæˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
5. GitHub ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
6. ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’ç›£è¦–

æ‰‹å‹•ã§ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹å ´åˆ:
```bash
# 1. mainãƒ–ãƒ©ãƒ³ãƒã‚’æœ€æ–°ã«
git checkout main
git pull origin main

# 2. æœ€æ–°ã‚¿ã‚°ã‚’ç¢ºèª
git tag -l --sort=-version:refname | head -1

# 3. æ¬¡ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚¿ã‚°ã‚’ä½œæˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
git tag v0.0.12
git push origin v0.0.12
```

## è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

å„æ©Ÿèƒ½ã®è©³ç´°ãªè¨­è¨ˆã¯ `specs/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‚ç…§ï¼š

| Feature | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | èª¬æ˜ |
|---------|-------------|------|
| CI/CD | `specs/001-ci-auto-deploy/` | è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š |
| Undo/Redo | `specs/002-undo-redo/` | æç”»å±¥æ­´ç®¡ç† |
| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | `specs/003-layer-structure/` | ãƒ¬ã‚¤ãƒ¤ãƒ¼æ©Ÿèƒ½ |
| URLå…±æœ‰ | `specs/004-url-share/` | å…±æœ‰æ©Ÿèƒ½ |
| ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ | `specs/005-compact-toolbar/` | UIã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– |
| OGP | `specs/006-ogp/` | SNSãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ |
| ã‚¿ã‚¤ãƒ«å®‰å®šæ€§ | `specs/007-tile-display-stability/` | è¡¨ç¤ºå®‰å®šåŒ– |

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ã‚¿ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- **ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥**: LRUæ–¹å¼ã€æœ€å¤§150ã‚¿ã‚¤ãƒ«
- **HTTPã‚­ãƒ£ãƒƒã‚·ãƒ¥**: `Cache-Control: max-age=31536000, immutable`
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°**: `?v={updatedAt}` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒˆ

### æç”»æœ€é©åŒ–
- **ã‚³ã‚¢ãƒ¬ãƒƒã‚·ãƒ³ã‚°ã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œ**: `getCoalescedEvents()` ã§ãƒ¢ãƒã‚¤ãƒ«æç”»ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«
- **æ•´æ•°åº§æ¨™**: ã‚¿ã‚¤ãƒ«å¢ƒç•Œã®ã‚®ãƒ£ãƒƒãƒ—ã‚’é˜²æ­¢

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã§ã‚¿ã‚¤ãƒ«ãŒè¡¨ç¤ºã•ã‚Œãªã„
```bash
# R2ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
cd backend
pnpm exec wrangler dev
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰
rm -rf backend/.wrangler/state/v3/d1/
pnpm exec wrangler d1 migrations apply DB --local
```

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

Private

## ä½œè€…

[@m0a](https://github.com/m0a)
