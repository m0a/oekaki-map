# Feature Specification: レイヤー構造機能

**Feature Branch**: `003-layer-structure`
**Created**: 2026-01-03
**Status**: Draft
**Input**: User description: "画像編集ソフトのレイヤー構造の概念を持たせたい"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 新しいレイヤーを作成する (Priority: P1)

ユーザーは複数のレイヤーを作成し、それぞれのレイヤーに独立して描画できる。これにより、背景と前景を分けたり、試行錯誤しながら描画できる。

**Why this priority**: レイヤー機能の基本であり、この機能がないと他のレイヤー操作は意味をなさない。

**Independent Test**: 新しいレイヤーを作成し、そのレイヤーに描画できることを確認する。

**Acceptance Scenarios**:

1. **Given** キャンバスが表示されている状態で、**When** ユーザーが「新しいレイヤー」ボタンをタップする、**Then** 新しいレイヤーが作成され、レイヤーリストに表示される
2. **Given** 複数のレイヤーがある状態で、**When** ユーザーが特定のレイヤーを選択して描画する、**Then** その描画は選択したレイヤーにのみ反映される
3. **Given** レイヤーが1つもない状態で、**When** キャンバスを開く、**Then** デフォルトで1つのレイヤーが自動的に作成される

---

### User Story 2 - レイヤーの表示/非表示を切り替える (Priority: P2)

ユーザーは各レイヤーの表示/非表示を切り替えて、特定のレイヤーだけを表示したり、全体の構成を確認できる。

**Why this priority**: レイヤーを使う主要なメリットの一つであり、作業効率に大きく影響する。

**Independent Test**: レイヤーの表示/非表示を切り替えて、画面上の描画内容が変わることを確認する。

**Acceptance Scenarios**:

1. **Given** 描画済みのレイヤーがある状態で、**When** ユーザーがそのレイヤーの「非表示」アイコンをタップする、**Then** そのレイヤーの内容がキャンバスから見えなくなる
2. **Given** 非表示のレイヤーがある状態で、**When** ユーザーがそのレイヤーの「表示」アイコンをタップする、**Then** そのレイヤーの内容がキャンバスに表示される
3. **Given** 非表示のレイヤーを選択した状態で、**When** ユーザーが描画する、**Then** 描画は実行されるが、レイヤーが非表示のため画面には見えない

---

### User Story 3 - レイヤーの順序を変更する (Priority: P3)

ユーザーはレイヤーの重ね順を変更して、どの描画が前面/背面に表示されるかを制御できる。

**Why this priority**: レイヤーの順序変更は重要だが、基本的な作成・表示機能があればある程度使える。

**Independent Test**: レイヤーの順序を入れ替えて、表示の前後関係が変わることを確認する。

**Acceptance Scenarios**:

1. **Given** 複数のレイヤーがある状態で、**When** ユーザーがレイヤーをドラッグして順序を変更する、**Then** キャンバス上の描画の前後関係が変更される
2. **Given** 背面のレイヤーに描画がある状態で、**When** そのレイヤーを前面に移動する、**Then** その描画が他のレイヤーの上に表示される

---

### User Story 4 - レイヤーを削除する (Priority: P4)

ユーザーは不要なレイヤーを削除して、キャンバスを整理できる。

**Why this priority**: 整理機能として重要だが、必須ではない。

**Independent Test**: レイヤーを削除して、そのレイヤーの内容がキャンバスから消えることを確認する。

**Acceptance Scenarios**:

1. **Given** 複数のレイヤーがある状態で、**When** ユーザーがレイヤーの「削除」ボタンをタップする、**Then** 確認ダイアログが表示される
2. **Given** 確認ダイアログが表示された状態で、**When** ユーザーが「削除」を確認する、**Then** そのレイヤーとその内容が完全に削除される
3. **Given** レイヤーが1つだけの状態で、**When** ユーザーがそのレイヤーを削除しようとする、**Then** 最低1つのレイヤーが必要なため、削除できないことが通知される

---

### User Story 5 - レイヤーに名前を付ける (Priority: P5)

ユーザーはレイヤーに名前を付けて、複数のレイヤーを識別しやすくする。

**Why this priority**: 便利な機能だが、レイヤー数が少ないうちは必須ではない。

**Independent Test**: レイヤー名を変更して、リストに反映されることを確認する。

**Acceptance Scenarios**:

1. **Given** レイヤーがある状態で、**When** ユーザーがレイヤー名をタップする、**Then** 名前を編集できる状態になる
2. **Given** 名前編集中の状態で、**When** ユーザーが新しい名前を入力して確定する、**Then** レイヤー名が更新される
3. **Given** 新しいレイヤーを作成した時、**Then** デフォルトで「レイヤー N」のような名前が付けられる

---

### Edge Cases

- 最大レイヤー数（10レイヤーを上限とする）に達した時、新規作成ボタンが無効になる
- すべてのレイヤーを非表示にした場合、キャンバスは空白で表示される
- 現在選択中のレイヤーを削除した場合、直近の下のレイヤーが自動選択される
- 地図を移動した後も、レイヤー構造と各レイヤーの内容が維持される

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST 新しいレイヤーを作成できる機能を提供する
- **FR-002**: System MUST デフォルトで1つのレイヤーを持つキャンバスを初期化する
- **FR-003**: System MUST 各レイヤーを独立して表示/非表示に切り替えられる
- **FR-004**: System MUST レイヤーの重ね順を変更できる
- **FR-005**: System MUST レイヤーを削除できる（最低1つは残す）
- **FR-006**: System MUST レイヤーに名前を付けられる
- **FR-007**: System MUST 現在選択中のレイヤーを視覚的に識別できる
- **FR-008**: System MUST 描画操作は現在選択中のレイヤーにのみ適用する
- **FR-009**: System MUST レイヤー数の上限を10個とする
- **FR-010**: System MUST レイヤー情報（順序、表示状態、名前）をサーバーサイド（D1/R2）に保存できる
- **FR-011**: System MUST Undo/Redo機能が全レイヤー共通の履歴として動作する（最後の操作をUndo/Redo）

### Key Entities

- **Layer（レイヤー）**: 描画内容を保持する独立した層。名前、表示状態、順序、描画データを持つ
- **Canvas（キャンバス）**: 複数のレイヤーを含む描画領域。レイヤーの集合を管理する
- **ActiveLayer（アクティブレイヤー）**: 現在選択されている編集対象のレイヤー

### UI/UX Design

- **レイヤーパネル**: 右側のサイドパネルとして配置。トグルボタンで表示/非表示を切り替え可能
- **パネル内容**: レイヤーリスト（ドラッグ&ドロップ対応）、各レイヤーの表示/非表示アイコン、削除ボタン、名前編集機能
- **新規レイヤーボタン**: パネル上部または下部に配置

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは3タップ以内で新しいレイヤーを作成できる
- **SC-002**: レイヤーの表示/非表示切り替えは即座に（1秒以内）画面に反映される
- **SC-003**: 10レイヤーを持つキャンバスでも、描画操作に遅延が発生しない
- **SC-004**: レイヤー操作（作成、削除、順序変更）後、ページリロードしてもレイヤー構造が維持される

## Clarifications

### Session 2026-01-03

- Q: レイヤーデータの永続化方法 → A: サーバーサイド（既存のD1/R2を拡張）
- Q: レイヤーパネルのUI配置 → A: 右側のサイドパネル（トグル可能）
- Q: Undo/Redoの動作範囲 → A: 全レイヤー共通（最後の操作をUndo）
- Q: レイヤー操作のUndo対象 → A: 含めない（描画操作のみUndo対象）
- Q: 既存キャンバスのマイグレーション → A: マイグレーション不要（動的に「レイヤー1」として解釈）

## Assumptions

- 既存の単一レイヤーのキャンバスは、データマイグレーション不要で動的に「レイヤー 1」として解釈する
- レイヤーの透明度（opacity）調整は本バージョンでは対象外とする
- レイヤーのブレンドモード（乗算、スクリーンなど）は本バージョンでは対象外とする
- レイヤーのロック機能は本バージョンでは対象外とする
- 各レイヤーは独立したUndo/Redo履歴を持つのではなく、キャンバス全体で1つの履歴を共有する
- レイヤー操作（作成、削除、順序変更、名前変更）はUndo/Redo対象外とする（描画操作のみ対象）
