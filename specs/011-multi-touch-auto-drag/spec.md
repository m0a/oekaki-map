# Feature Specification: マルチタッチ自動ドラッグモード切替

**Feature Branch**: `011-multi-touch-auto-drag`
**Created**: 2026-01-18
**Status**: Draft
**Input**: User description: "ペンモードはシングルタップ限定にしたいです。複数のタッチを検出中は自動でドラッグモードが望ましい"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - シングルタッチで描画継続 (Priority: P1)

タッチデバイス（スマートフォン、タブレット）でお絵かきマップを使用しているユーザーが、1本の指で画面をタッチして描画を行う。指を画面から離さずにスワイプすると、その軌跡が線として描画される。

**Why this priority**: 描画機能はアプリのコア機能であり、シングルタッチでの描画が正常に動作することが最も重要。この機能がなければアプリとして成立しない。

**Independent Test**: 1本指で画面をタッチしてドラッグし、線が描画されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ペンモード（draw）が選択されている状態, **When** ユーザーが1本の指で画面をタッチしてドラッグする, **Then** 指の軌跡に沿って線が描画される
2. **Given** 消しゴムモード（erase）が選択されている状態, **When** ユーザーが1本の指で画面をタッチしてドラッグする, **Then** 指の軌跡に沿って線が消去される

---

### User Story 2 - マルチタッチで自動ドラッグモード切替 (Priority: P1)

タッチデバイスでお絵かきマップを使用しているユーザーが、描画中に地図を移動したくなった。2本以上の指で画面をタッチすると、自動的にドラッグモード（地図操作モード）に切り替わり、ピンチズームやパンが可能になる。

**Why this priority**: これがこのissueの主要な要求事項であり、ユーザーがモード切替ボタンを押さずに自然に地図操作できることがUX改善の核心。

**Independent Test**: ペンモード中に2本指でピンチ操作を行い、地図がズームされることを確認できる。

**Acceptance Scenarios**:

1. **Given** ペンモード（draw）が選択されている状態で1本指で描画中, **When** 2本目の指が画面にタッチされる, **Then** 即座にドラッグモードに切り替わり地図操作が可能になる
2. **Given** ペンモード（draw）が選択されている状態, **When** 最初から2本以上の指で画面をタッチする, **Then** 描画されずにドラッグモードとして地図操作が可能になる
3. **Given** 消しゴムモード（erase）が選択されている状態, **When** 2本以上の指で画面をタッチする, **Then** 消去されずにドラッグモードとして地図操作が可能になる

---

### User Story 3 - マルチタッチ解除後の描画モード復帰 (Priority: P2)

2本指での地図操作を終えたユーザーが、再び描画を続けたい。すべての指を画面から離して再度1本指でタッチすると、元の描画モードに戻って描画を続けられる。

**Why this priority**: 描画と地図操作を頻繁に切り替えるユースケースにおいて、スムーズな復帰が必要。ただしP1の機能が動作すれば最低限使える。

**Independent Test**: 2本指操作後に指を離し、1本指で描画できることを確認。

**Acceptance Scenarios**:

1. **Given** 元々ペンモードだった状態でマルチタッチによりドラッグモードに切り替わっている, **When** すべての指を画面から離す, **Then** 元のペンモードに復帰する
2. **Given** 元々消しゴムモードだった状態でマルチタッチによりドラッグモードに切り替わっている, **When** すべての指を画面から離す, **Then** 元の消しゴムモードに復帰する
3. **Given** マルチタッチ中にドラッグモードになっている状態, **When** 2本目以降の指を離して1本指だけになる, **Then** すべての指が離れるまでドラッグモードを維持する（誤描画防止）

---

### Edge Cases

- **描画中に2本目の指がタッチされた場合**: 描画中のストロークは確定（保存）され、即座にドラッグモードに切り替わる
- **高速なタッチ操作時**: 2本の指がほぼ同時にタッチされた場合（100ms以内）、描画が開始されずドラッグモードとして扱う
- **3本以上の指でタッチした場合**: 2本以上は全てドラッグモードとして扱う（ピンチズームは標準的に2本指で動作）
- **マウス操作時**: マウス操作ではこの機能は影響しない（マウスはシングルポイントのみ）
- **スタイラスペン使用時**: スタイラスペンは1本指と同様に扱い、描画モードで動作する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、ペンモードまたは消しゴムモード選択時に、1本のタッチポイントのみを検出している場合、通常通り描画/消去を行わなければならない
- **FR-002**: システムは、ペンモードまたは消しゴムモード選択時に、2本以上のタッチポイントを検出した場合、自動的にドラッグモード（地図操作）に切り替えなければならない
- **FR-003**: システムは、マルチタッチによるドラッグモード中にすべてのタッチポイントが解除された場合、元のモード（ペン/消しゴム）に復帰しなければならない
- **FR-004**: システムは、描画中に2本目のタッチポイントが追加された場合、進行中のストロークを確定してからドラッグモードに切り替えなければならない
- **FR-005**: システムは、マルチタッチ中に一部の指が離れても（1本以上残っていれば）、すべての指が離れるまでドラッグモードを維持しなければならない
- **FR-006**: システムは、ツールバーのモード選択状態を視覚的に維持しなければならない（一時的なドラッグモード中もユーザーが選択したモードのアイコンはハイライトされたまま）

### Assumptions

- タッチデバイスはPointer Events APIに対応している（現代のブラウザはほぼ全て対応）
- 「ほぼ同時」のタッチは100ms以内とする（業界標準的なマルチタッチ検出閾値）
- スタイラスペンはpointerTypeが"pen"として検出され、1本指タッチと同等に扱う

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーがペンモード選択時に2本指でピンチ操作を行った際、100%の確率で地図のズームが動作する
- **SC-002**: ユーザーがペンモード選択時に1本指で描画した際、100%の確率で線が描画される（誤って地図操作にならない）
- **SC-003**: マルチタッチからシングルタッチへの切り替え時、誤描画（意図しない線）が発生しない
- **SC-004**: モード切替の遅延がユーザーに知覚されない（操作開始から100ms以内に適切なモードが適用される）
