# Feature Specification: タイル表示安定性の修正

**Feature Branch**: `007-tile-display-stability`
**Created**: 2026-01-04
**Status**: Draft
**Input**: User description: "tile images問題の対応 - タイル表示の安定性修正"

## 背景・問題

現在、地図上に描画した絵（タイル画像）が表示されたり消えたりする不安定な挙動が発生している。また、タイル画像のHTTPキャッシュが無効化されているため、R2へのリクエスト負荷とコストが増加している。

### 根本原因1: フロントエンドのレースコンディション

1. **タイル読み込みuseEffect**: サーバーからタイル画像を取得してCanvasに描画
2. **ストロークuseEffect**: Canvasを`clearRect()`で全消去し、ストロークのみ再描画

これら2つのuseEffectが独立して実行されるため、実行順序によってはタイルが消失する。

```
タイル読み込み完了 → Canvas描画
                      ↓
ストローク変更検知 → Canvas全消去 → ストロークのみ再描画（タイル消失）
```

### 根本原因2: HTTPキャッシュの無効化

現在、タイル画像のレスポンスヘッダーは `Cache-Control: public, max-age=0, must-revalidate` となっており、ブラウザ/CDNキャッシュが効かない。これにより：

- マップ移動のたびにR2へリクエスト
- ページリロードのたびにR2へリクエスト
- R2のリクエスト課金が増加

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 安定したタイル表示 (Priority: P1)

ユーザーが以前描いた絵を含むキャンバスを開いた時、描画内容が安定して表示される。ページをリロードしても、地図を移動しても、描いた絵が消えることなく常に表示される。

**Why this priority**: アプリの基本機能であり、これが動作しないとユーザーは作品を見ることができない。最も重要な修正。

**Independent Test**: キャンバスを開いて10回リロードし、毎回タイルが正しく表示されることを確認

**Acceptance Scenarios**:

1. **Given** 保存済みの描画があるキャンバス, **When** キャンバスページを開く, **Then** 描画内容が100%の確率で表示される
2. **Given** 表示されているキャンバス, **When** ページをリロードする, **Then** 描画内容が消えることなく再表示される
3. **Given** 表示されているキャンバス, **When** 地図をパン/ズームする, **Then** 描画内容が一瞬消えることなく追従する

---

### User Story 2 - Undo/Redo時の表示安定性 (Priority: P2)

ユーザーがUndo/Redoを実行した際、保存済みのタイル（背景）が消えることなく、ストローク履歴のみが変更される。

**Why this priority**: Undo/Redo機能はユーザーが頻繁に使用する機能であり、その際に既存の絵が消えると混乱を招く。

**Independent Test**: タイルが表示された状態でUndo/Redoを10回繰り返し、タイルが消えないことを確認

**Acceptance Scenarios**:

1. **Given** 保存済みタイルと未保存ストロークがあるキャンバス, **When** Undoを実行, **Then** 保存済みタイルは維持されストロークのみ戻る
2. **Given** Undo後の状態, **When** Redoを実行, **Then** 保存済みタイルは維持されストロークが復元される

---

### User Story 3 - 描画モード切替時の表示安定性 (Priority: P3)

ユーザーがナビゲートモードと描画モードを切り替えた際、表示されているタイルが消えない。

**Why this priority**: モード切替は頻繁に行われる操作であり、その度に表示が不安定になるとユーザー体験を損なう。

**Independent Test**: モードを10回切り替え、毎回タイルが維持されることを確認

**Acceptance Scenarios**:

1. **Given** タイルが表示されたナビゲートモード, **When** 描画モードに切り替え, **Then** タイルは維持される
2. **Given** タイルが表示された描画モード, **When** ナビゲートモードに切り替え, **Then** タイルは維持される

---

### User Story 4 - HTTPキャッシュによるコスト削減 (Priority: P2)

タイル画像がブラウザ/CDNにキャッシュされ、同じタイルへの重複リクエストがR2まで到達しない。描画を保存した場合のみ、そのタイルの新しい画像が取得される。

**Why this priority**: R2のリクエスト課金を削減し、ユーザー体験（読み込み速度）も向上する。

**Independent Test**: 同じキャンバスで地図を移動→戻るを繰り返し、ネットワークタブでR2へのリクエストがキャッシュヒットしていることを確認

**Acceptance Scenarios**:

1. **Given** タイルが表示されたキャンバス, **When** 地図を移動して戻ってくる, **Then** タイル画像はブラウザキャッシュから取得される
2. **Given** タイルが表示されたキャンバス, **When** ページをリロードする, **Then** タイル画像はブラウザキャッシュから取得される
3. **Given** 描画を保存したタイル, **When** 次回そのタイルを取得, **Then** 新しい画像がR2から取得される（古いキャッシュは使われない）

---

### Edge Cases

- ネットワークが遅い環境で大量のタイルを読み込む場合：タイルは順次表示され、読み込み中に他の操作をしても消えない
- タイル読み込み中にUndo/Redoを実行した場合：読み込み完了後にタイルが正しく表示される
- 同時に複数の描画更新がトリガーされた場合：最終的に全ての描画内容が正しく表示される
- タイル保存直後にリロードした場合：新しいタイル画像が取得され、古いキャッシュは使用されない

## Requirements *(mandatory)*

### Functional Requirements

**表示安定性**:
- **FR-001**: システムは、タイル画像を取得後にメモリ内にキャッシュを保持しなければならない
- **FR-002**: システムは、Canvas再描画時に必ずキャッシュされたタイルを先に描画しなければならない
- **FR-003**: システムは、ストローク再描画（Undo/Redo）時にタイルを保持したまま描画しなければならない
- **FR-004**: システムは、タイル読み込みとストローク描画の実行順序を保証しなければならない（タイル→ストロークの順）
- **FR-005**: ユーザーは、タイル読み込み中でも他の操作を行えなければならない（UIがブロックされない）

**HTTPキャッシュ最適化**:
- **FR-006**: バックエンドは、タイルメタデータAPIで各タイルの`updatedAt`を返却しなければならない
- **FR-007**: フロントエンドは、タイル画像URLにバージョンパラメータ（`?v={updatedAt}`）を付与しなければならない
- **FR-008**: バックエンドは、タイル画像レスポンスに長期キャッシュヘッダー（`max-age=31536000`）を設定しなければならない
- **FR-009**: タイル保存時、システムは該当タイルの`updatedAt`を更新しなければならない

### Key Entities

- **TileCache**: 読み込み済みタイル画像のメモリ内キャッシュ。キャンバスIDとタイル座標をキーとして画像データを保持
- **RenderQueue**: 描画操作のキュー。タイル描画とストローク描画の順序を管理

## Success Criteria *(mandatory)*

### Measurable Outcomes

**表示安定性**:
- **SC-001**: キャンバスを開いた際、100%の確率でタイルが正しく表示される（10回のリロードテストで全て成功）
- **SC-002**: Undo/Redoを10回連続実行しても、保存済みタイルが消失しない
- **SC-003**: ナビゲートモードと描画モードを20回切り替えても、タイルが消失しない
- **SC-004**: タイル読み込み中にユーザー操作（モード切替、Undo/Redo）を行っても、最終的に正しい状態が表示される

**HTTPキャッシュ**:
- **SC-005**: 地図を移動→戻るを5回繰り返した際、タイル画像リクエストの80%以上がキャッシュヒットする
- **SC-006**: 描画保存後、保存したタイルのみが新しいURLで取得され、未変更タイルはキャッシュから取得される

## Assumptions

- タイル画像は比較的小さい（256x256ピクセル）ため、メモリキャッシュは現実的なサイズに収まる
- 同時に表示されるタイル数は最大でも100枚程度（4ズームレベル × 25タイル程度）
- ブラウザのメモリは十分にあり、タイルキャッシュによるメモリ不足は発生しない

## Out of Scope

- タイル画像の圧縮・最適化（現状のWebP 0.8品質を維持）
- オフライン対応（Service Worker等）
- メモリキャッシュのIndexedDB永続化
