# Feature Specification: 描画のUndo/Redo機能

**Feature Branch**: `002-undo-redo`
**Created**: 2026-01-03
**Status**: Draft
**Input**: User description: "描画のundo redo機能が欲しい"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 直前の描画操作を取り消す (Priority: P1)

ユーザーが地図上で描画中に間違えた場合、直前の描画操作（ストローク）を取り消して元に戻したい。

**Why this priority**: ユーザーが描画ミスをしたときに即座に修正できることは、スムーズな描画体験の基本であり、最も頻繁に使用される機能。

**Independent Test**: Undoボタンをタップして直前のストロークが消えることを確認することで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーが1つ以上のストロークを描画した状態, **When** Undoボタンをタップする, **Then** 直前のストロークが画面から消える
2. **Given** ユーザーがUndo可能なストロークがない状態, **When** Undoボタンを見る, **Then** Undoボタンは無効化（グレーアウト）されている
3. **Given** ユーザーが複数のストロークを描画した状態, **When** Undoボタンを連続でタップする, **Then** ストロークが描画順の逆順で1つずつ消えていく

---

### User Story 2 - 取り消した操作をやり直す (Priority: P2)

ユーザーがUndo操作を行った後、やはりその操作が必要だったと気づいた場合、Redo機能で取り消した操作を復元したい。

**Why this priority**: Undoを間違えてしまった場合のリカバリー手段として重要だが、Undo機能があってこそ意味を持つため、P2に設定。

**Independent Test**: Undo後にRedoボタンをタップして、消えたストロークが復元されることを確認することで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーがUndo操作を行った後の状態, **When** Redoボタンをタップする, **Then** Undoで消えたストロークが復元される
2. **Given** Redo可能な操作がない状態, **When** Redoボタンを見る, **Then** Redoボタンは無効化（グレーアウト）されている
3. **Given** ユーザーがUndo操作を行った後, **When** 新しいストロークを描画する, **Then** Redo履歴はクリアされ、Redoボタンは無効化される

---

### User Story 3 - キーボードショートカットでUndo/Redo (Priority: P3)

デスクトップユーザーがキーボードを使用している場合、慣れ親しんだショートカットキー（Ctrl+Z / Ctrl+Y）でUndo/Redoを実行したい。

**Why this priority**: デスクトップユーザーのUXを向上させるが、モバイルユーザーには適用されないため、タッチ操作用のボタンが先に実装されるべき。

**Independent Test**: Ctrl+Zキーを押してUndoが実行されることを確認することで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーがストロークを描画した状態でキーボード操作可能, **When** Ctrl+Z（Mac: Cmd+Z）を押す, **Then** 直前のストロークがUndoされる
2. **Given** ユーザーがUndo操作を行った後, **When** Ctrl+Y（Mac: Cmd+Shift+Z）を押す, **Then** Undoした操作がRedoされる

---

### Edge Cases

- ページをリロードした場合、Undo/Redo履歴はクリアされ、保存済みの状態から再開する
- 複数のズームレベルにまたがる描画をUndoした場合、該当するズームレベルのタイルのみ更新される
- サーバーに保存済みのストロークをUndoした場合、ローカルで即座にUndoし、次回保存時にサーバーと同期する
- 履歴の上限（50回）に達した場合、最も古い履歴から自動的に削除される
- 消しゴムモードでの操作も1つのストロークとしてUndo対象となる

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは各ストローク（ペンを下ろしてから上げるまでの一連の描画）を1つのUndo単位として記録しなければならない
- **FR-002**: システムはUndo操作時に直前のストロークを画面から削除し、Redo履歴に追加しなければならない
- **FR-003**: システムはRedo操作時にRedo履歴から最新のストロークを復元し、画面に表示しなければならない
- **FR-004**: システムは新しいストロークが描画されたときにRedo履歴をクリアしなければならない
- **FR-005**: システムはUndo/Redo可能な操作がない場合、対応するボタンを無効化状態で表示しなければならない
- **FR-006**: システムはUndo/Redo操作後の状態をサーバーに自動保存しなければならない
- **FR-007**: システムはセッション内で最大50回分のUndo履歴を保持しなければならない
- **FR-008**: システムはデスクトップ環境でキーボードショートカット（Ctrl+Z/Ctrl+Y、Mac: Cmd+Z/Cmd+Shift+Z）によるUndo/Redoをサポートしなければならない
- **FR-009**: Undo/Redoボタンは既存のツールバー内に配置しなければならない
- **FR-010**: Undo/Redo操作はナビゲートモードを含むすべてのモードで利用可能でなければならない

### Key Entities

- **ストローク履歴**: 描画されたストロークの情報（座標データ、色、太さ、タイムスタンプ）を保持する履歴スタック
- **Redo履歴**: Undoされたストロークを一時的に保持し、Redo操作で復元するためのスタック

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーはUndo/Redo操作を0.1秒以内に完了できる（操作から画面反映まで）
- **SC-002**: 50回連続でUndo操作を行っても、すべてのストロークが正しく取り消される
- **SC-003**: Undo/Redo後の描画データがサーバーと正しく同期され、ページリロード後も保持される
- **SC-004**: デスクトップユーザーの80%以上がキーボードショートカットでUndo/Redo操作を実行できる

## Clarifications

### Session 2026-01-03

- Q: Undo/Redoボタンの配置場所は？ → A: 既存のツールバー内に配置
- Q: ナビゲートモード時のUndo/Redo操作は？ → A: ナビゲートモードでもUndo/Redo可能

## Assumptions

- ストロークの履歴はクライアントサイドのメモリ内で管理し、ページリロード時にはクリアされる
- Undo/Redo操作はローカルで即座に反映し、サーバー同期は既存の自動保存機能を通じて非同期で行う
- 履歴の上限（50回）を超えた場合は、古い履歴から自動的に削除される
- 消しゴムモードでの操作も1つのストロークとしてUndo対象となる
