# Feature Specification: URL共有ボタン・現在位置取得ボタン

**Feature Branch**: `004-url-share`
**Created**: 2026-01-03
**Status**: Draft
**Input**: User description: "url共有ボタンを付けて下さい。スマホからだとそのままxやLINEに投げられるように。共有時に中心座標をDBに保存し、開くと共有時の位置に移動する。現在位置取得ボタンも追加"

## Clarifications

### Session 2026-01-03

- Q: 共有時にズームレベルも一緒に保存しますか？ → A: ズームレベルも保存する（座標+ズーム）
- Q: 共有ボタンは誰でも使えますか？ → A: 誰でも可能（アカウント機能なし、閲覧者も保存・上書き可能）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - スマホからSNS共有（座標保存） (Priority: P1)

スマートフォンユーザーが自分の描いた地図をX（Twitter）やLINEに直接共有できる。共有ボタンをタップすると、現在の中心座標がDBに保存され、OSのネイティブ共有シートが開く。URLはシンプルなまま（パラメータなし）で共有される。

**Why this priority**: スマホユーザーが主なターゲットであり、ネイティブ共有シートを使うことで最も自然なユーザー体験を提供できる。

**Independent Test**: スマホで地図を開き、特定の場所に移動してから共有ボタンをタップして、XやLINEアプリにシンプルなURLを送信できることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーがスマホで地図を閲覧している, **When** 共有ボタンをタップする, **Then** 現在の中心座標がDBに保存され、OSのネイティブ共有シートが開く
2. **Given** 共有シートが開いている, **When** Xを選択する, **Then** シンプルなURL（パラメータなし）とタイトルがXの投稿画面にプリセットされる
3. **Given** 共有シートが開いている, **When** LINEを選択する, **Then** シンプルなURLがLINEのメッセージ入力欄にプリセットされる

---

### User Story 2 - 共有URLを開くと保存された座標に移動 (Priority: P1)

共有されたURLを開くと、DBに保存された中心座標に地図が自動的に移動する。共有者が見ていた場所を受信者も同じ視点で見られる。

**Why this priority**: 共有機能の核心的な価値であり、座標共有がなければユーザーは手動で場所を探す必要がある。

**Independent Test**: 共有されたURLをブラウザで開き、地図がDBに保存された座標を中心に表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが共有URLを受け取った, **When** URLをブラウザで開く, **Then** 地図はDBに保存された中心座標を中心に表示される
2. **Given** 中心座標がDBに保存されていない地図のURL, **When** URLをブラウザで開く, **Then** 地図はデフォルトの中心座標で表示される

---

### User Story 3 - 現在位置に移動 (Priority: P1)

ユーザーが現在位置取得ボタンをタップすると、GPSから取得した現在地に地図が移動する。外出先で自分の位置を基準に地図を操作したい場合に便利。

**Why this priority**: モバイルユーザーにとって現在位置への移動は基本的なナビゲーション機能であり、共有機能と組み合わせて使用される。

**Independent Test**: スマホで地図を開き、現在位置取得ボタンをタップして、地図が現在地を中心に表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが地図を閲覧している, **When** 現在位置取得ボタンをタップする, **Then** 位置情報の許可を求めるダイアログが表示される（未許可の場合）
2. **Given** 位置情報が許可されている, **When** 現在位置取得ボタンをタップする, **Then** 地図がGPSから取得した現在地を中心に移動する
3. **Given** 現在位置を取得中, **When** 取得が完了する, **Then** 地図がスムーズに現在地へ移動する

---

### User Story 4 - デスクトップからURLコピー（座標保存） (Priority: P2)

PCユーザーが地図のURLをクリップボードにコピーして、任意のアプリに貼り付けられる。ネイティブ共有シートが使えない環境でのフォールバック。コピー時に現在の中心座標がDBに保存される。

**Why this priority**: デスクトップユーザーにも共有機能を提供する必要があるが、スマホほど頻繁には使われない想定。

**Independent Test**: PCブラウザで地図を開き、特定の場所に移動してから共有ボタンをクリックして、URLがクリップボードにコピーされ、中心座標がDBに保存されることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーがPCブラウザで地図を閲覧している, **When** 共有ボタンをクリックする, **Then** 現在の中心座標がDBに保存され、URLがクリップボードにコピーされる
2. **Given** URLがクリップボードにコピーされた, **When** コピー完了後, **Then** ユーザーに「URLをコピーしました」のフィードバックが表示される

---

### Edge Cases

- Web Share APIに対応していないブラウザでは、クリップボードコピーにフォールバックする
- 共有対象の地図がまだ保存されていない場合、共有ボタンは無効化またはエラーメッセージを表示する
- クリップボードへのコピーが失敗した場合（ブラウザ制限など）、ユーザーにエラーを通知する
- DBへの座標保存が失敗した場合、エラーを通知しつつ共有自体は続行する（座標なしで共有）
- 中心座標がDBに保存されていない地図を開いた場合、デフォルトの中心座標で表示する
- 位置情報の取得が拒否された場合、ユーザーに設定変更を促すメッセージを表示する
- 位置情報の取得がタイムアウトした場合、エラーメッセージを表示する
- Geolocation APIに対応していないブラウザでは、現在位置取得ボタンを非表示または無効化する

## Requirements *(mandatory)*

### Functional Requirements

#### 共有機能

- **FR-001**: システムは地図の表示画面に共有ボタンを表示しなければならない
- **FR-002**: システムはWeb Share APIに対応したブラウザでネイティブ共有シートを起動しなければならない
- **FR-003**: システムはWeb Share API非対応環境でクリップボードにURLをコピーしなければならない
- **FR-004**: システムは共有時に現在の中心座標とズームレベルをDBに保存しなければならない
- **FR-005**: システムは共有時に地図のタイトル（マップ名）をテキストとして含めなければならない
- **FR-006**: システムは共有操作の成功・失敗をユーザーにフィードバックしなければならない
- **FR-007**: システムは保存されていない地図では共有機能を利用不可にしなければならない
- **FR-008**: システムは地図表示時にDBから保存された中心座標とズームレベルを読み取り、その状態で地図を表示しなければならない
- **FR-009**: システムは中心座標がDBに保存されていない場合、デフォルトの中心座標で表示しなければならない

#### 現在位置取得機能

- **FR-010**: システムは地図の表示画面に現在位置取得ボタンを表示しなければならない
- **FR-011**: システムは現在位置取得ボタンがタップされたとき、Geolocation APIを使用して現在位置を取得しなければならない
- **FR-012**: システムは現在位置の取得に成功したとき、地図をその座標を中心に移動しなければならない
- **FR-013**: システムは位置情報の取得中、ローディング状態をユーザーに表示しなければならない
- **FR-014**: システムは位置情報の取得に失敗したとき、エラーメッセージをユーザーに表示しなければならない
- **FR-015**: システムはGeolocation API非対応環境で現在位置取得ボタンを非表示または無効化しなければならない

### Key Entities

- **共有データ**: 地図のURL、地図のタイトル（マップ名）
- **共有ボタン**: 地図表示画面に配置されるUI要素
- **現在位置取得ボタン**: 地図表示画面に配置されるUI要素
- **共有ビュー状態**: DBに保存される緯度・経度・ズームレベル情報（マップエンティティの属性として追加）
- **現在位置**: Geolocation APIから取得される緯度・経度情報

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは2タップ/クリック以内で共有を完了できる（ボタンタップ→アプリ選択）
- **SC-002**: スマホでの共有操作は1秒以内に共有シートが表示される
- **SC-003**: デスクトップでのコピー操作後、即座にフィードバックが表示される
- **SC-004**: Web Share API対応デバイスの90%以上でネイティブ共有シートが正常に動作する
- **SC-005**: 共有URLを開いた際、1秒以内に保存された座標を中心に地図が表示される
- **SC-006**: 共有されたURLを開いた受信者は、共有者と同じ場所を閲覧できる
- **SC-007**: 現在位置取得ボタンをタップ後、5秒以内に現在地へ地図が移動する（GPS精度に依存）
- **SC-008**: 位置情報エラー時、即座にユーザーにフィードバックが表示される

## Assumptions

- 地図には一意のURLが既に割り当てられている（既存の共有機能を前提）
- 地図のタイトル（マップ名）は既存のデータ構造から取得可能
- モバイルブラウザの大半（Safari、Chrome）はWeb Share APIに対応している
- 共有ビュー状態は緯度・経度・ズームレベルのセットとしてDBに保存される
- 共有ボタンを押すたびにDBの共有ビュー状態が更新される（最後に共有した時点の状態が保存される）
- アカウント機能は存在しないため、誰でも共有ボタンを使用でき、ビュー状態を上書きできる
- モダンブラウザの大半はGeolocation APIに対応している
- 位置情報の精度はデバイスのGPS性能に依存する
