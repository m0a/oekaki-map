# Feature Specification: タイルマップ追従

**Feature Branch**: `008-tile-map-sync`
**Created**: 2026-01-04
**Status**: Draft
**Input**: User description: "マップをドラック移動時、拡大縮小時に画像タイルも動きを追従させてほしい。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - スムーズなマップ移動体験 (Priority: P1)

ユーザーがナビゲートモードでマップをドラッグ移動する際、自分が描いた画像タイルがマップと一体となって動く。現在の挙動では、マップ移動中は描画タイルが固定されており、移動完了後に「カクッ」と正しい位置にスナップするため、違和感がある。

**Why this priority**: マップ操作の基本体験であり、すべてのユーザーが頻繁に行う操作。スムーズな追従がなければ、描画とマップが別々のレイヤーに見えてしまい、一体感のある描画体験を損なう。

**Independent Test**: ナビゲートモードに切り替えてマップをドラッグし、描画済みタイルがリアルタイムでマップと同期して動くことを確認できる。

**Acceptance Scenarios**:

1. **Given** 描画済みタイルが表示されているマップ, **When** ナビゲートモードでマップをドラッグする, **Then** 描画タイルがマップのベースタイルと同期してリアルタイムで移動する
2. **Given** マップをドラッグ中, **When** ドラッグを継続する, **Then** 描画タイルとマップタイルの位置関係が常に維持される（ズレが発生しない）
3. **Given** ドラッグ操作中, **When** 指を離す（ドラッグ終了）, **Then** 追加の位置調整アニメーションなしで描画タイルが正しい位置に表示され続ける

---

### User Story 2 - スムーズなズーム体験 (Priority: P1)

ユーザーがマップを拡大・縮小する際、描画タイルがマップと一体となって拡大・縮小する。現在の挙動では、ズーム中にタイルが固定されたままで、ズーム完了後にスケールが変わるため、不自然に見える。

**Why this priority**: ズームはマップ操作の基本機能であり、P1のドラッグ移動と同等に重要。ズーム時の追従がなければ描画体験の一体感が損なわれる。

**Independent Test**: ピンチズームまたはスクロールホイールでズームし、描画済みタイルがリアルタイムでスケールすることを確認できる。

**Acceptance Scenarios**:

1. **Given** 描画済みタイルが表示されているマップ, **When** ピンチズームで拡大する, **Then** 描画タイルがズーム中心を基準にマップと同期してリアルタイムで拡大する
2. **Given** 描画済みタイルが表示されているマップ, **When** スクロールホイールで縮小する, **Then** 描画タイルがマウスカーソル位置を基準にマップと同期してリアルタイムで縮小する
3. **Given** ズーム操作中, **When** ズームが完了する, **Then** 描画タイルが新しいズームレベルに適した解像度で再描画される

---

### User Story 3 - モバイルでのスムーズな操作 (Priority: P2)

モバイルデバイスでタッチ操作（ドラッグ、ピンチズーム）を行う際も、デスクトップと同様に描画タイルがスムーズに追従する。

**Why this priority**: モバイル利用者の体験を確保するため重要だが、基本的な追従機能（P1）が実装されていればモバイル対応は技術的に同時に達成されることが多い。

**Independent Test**: モバイルデバイス（または開発者ツールのモバイルエミュレーション）でタッチ操作を行い、デスクトップと同等の追従体験を確認できる。

**Acceptance Scenarios**:

1. **Given** モバイルデバイスで描画済みマップを表示, **When** 1本指でドラッグする, **Then** 描画タイルがスムーズに追従する
2. **Given** モバイルデバイスで描画済みマップを表示, **When** 2本指でピンチズームする, **Then** 描画タイルがピンチの中心を基準にスムーズにスケールする
3. **Given** 高速なスワイプ操作を行う, **When** 慣性スクロールが発生する, **Then** 描画タイルが慣性スクロール中も追従し続ける

---

### Edge Cases

- **急速な連続ズーム**: 短時間に複数回ズームイン・アウトを繰り返した場合でも、描画タイルの位置・スケールが正しく維持される
- **境界付近での操作**: 描画可能ズーム範囲（16-19）の境界付近でズームした場合、タイルの表示/非表示が適切に処理される
- **大量タイルの表示**: 多数のタイルが画面上に存在する場合でも、パフォーマンスを維持しながら追従する
- **ネットワーク遅延**: タイル読み込み中でも、すでにキャッシュされたタイルは正しく追従する
- **回転操作**: 一部デバイスで可能な回転ジェスチャー時の挙動（現状回転は無効であれば、追従機能導入後も無効のまま）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、マップのドラッグ移動中に描画タイルをリアルタイムで追従表示しなければならない
- **FR-002**: システムは、マップのズーム操作中に描画タイルをリアルタイムでスケーリング表示しなければならない
- **FR-003**: システムは、ドラッグ・ズーム操作完了時に追加の位置調整アニメーションなしで最終位置に描画タイルを表示しなければならない
- **FR-004**: システムは、タッチデバイスでのジェスチャー操作（1本指ドラッグ、2本指ピンチ）においても同等の追従体験を提供しなければならない
- **FR-005**: システムは、ズーム完了後に新しいズームレベルに適した解像度でタイルを再描画しなければならない
- **FR-006**: システムは、慣性スクロール中も描画タイルを追従させなければならない
- **FR-007**: 描画モードおよび消しゴムモード中は、既存の動作（マップ移動無効、描画優先）を維持しなければならない

### Non-Functional Requirements

- **NFR-001**: 追従表示は60fpsを目標とし、ユーザーが視覚的なカクつきを感じない程度のスムーズさを維持する
- **NFR-002**: 大量のタイル（100枚以上）が表示されている場合でも、操作に対する応答性を維持する

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: マップ移動中、描画タイルとベースマップタイルの位置ずれが視認できないレベル（1ピクセル以下）で追従する
- **SC-002**: ズーム操作中、描画タイルのスケーリングがベースマップと同期し、操作終了まで位置ずれが発生しない
- **SC-003**: 操作完了時に描画タイルの「スナップ」や「ジャンプ」といった不自然な位置調整が発生しない
- **SC-004**: モバイルデバイスでもデスクトップと同等のスムーズな追従体験が提供される
- **SC-005**: 追従処理の導入により、既存の描画機能（ペン、消しゴム、Undo/Redo）に悪影響が発生しない

## Assumptions

- 現在のLeafletベースのマップ実装を維持する
- 描画可能ズーム範囲（16-19）は変更しない
- 既存のタイルキャッシュシステム（TileCache）を活用する
- 追従はナビゲートモード時のみ適用され、描画モード・消しゴムモード時のマップ操作は現状通り無効
